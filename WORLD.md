
# WORLD.md

Этот файл описывает «картину мира» проекта и протоколы.

## Неподвижные основы

- Boot-ячейка Colab — неизменяема.
- `/panic` и `/restart` обрабатываются супервизором (не LLM) и неизменны.
- Секреты никогда не логируются и не коммитятся.
- **Способность агента к самомодификации — фундаментальный инвариант.**
- Любые изменения, ломающие или убирающие возможность агента менять собственный код/промпты/логику, запрещены.

## Протокол веток

- main: человек (Cursor)
- ouroboros: агент
- ouroboros-stable: откат

## Протокол логирования

- Логи в Drive: `MyDrive/Ouroboros/logs/*.jsonl`
- Каждое существенное действие пишется в logs/events.jsonl и logs/tools.jsonl
- В чат добавляется бюджетная строка, но **не на каждое сообщение**: она показывается по cadence сообщений (по умолчанию раз в 10). `/status` печатает бюджет всегда.
- Переключения модельных профилей (model/reasoning effort) логируются в events и озвучиваются владельцу в Telegram.

## Протокол инструментов правок

- Если доступен Claude Code CLI (`ANTHROPIC_API_KEY` + `claude`), основной инструмент редактирования кода — `claude_code_edit(...)`.
- Для сложных и/или многофайловых задач сначала выбирается `claude_code_edit(...)`, затем `repo_commit_push(...)`.
- `repo_write_commit(...)` используется как fallback для маленьких детерминированных правок, где финальный контент заранее ясен.
- В evolution-режиме приоритет `claude_code_edit(...)` должен соблюдаться максимально часто, без нарушения веточного протокола.

## Протокол рабочей памяти

- Рабочая память хранится в `MyDrive/Ouroboros/memory/scratchpad.md`.
- После каждой задачи формируется компактная дельта (без воды) и пишется в `memory/scratchpad_journal.jsonl`.
- В `RecentEvidence` добавляются короткие цитаты ключевых команд и ошибок (если были).
- Актуальный self-model хранится в `MyDrive/Ouroboros/memory/identity.md` и обновляется периодически на основе фактических логов/журнала.

## Протокол idle-поведения

- Idle-задачи ставятся только когда нет активных/ожидающих задач владельца.
- Idle-задачи ограничены cooldown, бюджетным порогом и дневным лимитом.
- Типы idle-задач: консолидация памяти, анализ производительности, идеи улучшений, web learning, проактивные предложения владельцу.

## Протокол deep-review

- Полный deep-review может запускаться командой владельца (`/review`), после evolution-циклов и после сложных задач.
- В review используется fit-or-chunk стратегия: если всё не помещается в один контекст, анализ разбивается на несколько чанков.
- Перед review сообщается оценка входных токенов; после review сообщается итоговая стоимость.
- Результат review отправляется владельцу, попадает в рабочую память и влияет на следующие self-improvement шаги.

## Протокол очереди и антизависаний

- Очередь приоритетная: `task/review` > `evolution` > `idle` (FIFO сохраняется внутри одного приоритета).
- По активным задачам идёт heartbeat; `/status` показывает состояние очереди и running-задач.
- Таймауты супервизора: soft-уровни для анализа/уведомлений и hard-уровень для принудительного kill+respawn+retry.
- Состояние очереди периодически снимется в snapshot для восстановления после падений супервизора.

## Протокол инженерной простоты

- При каждом изменении учитывай стоимость роста кодовой базы.
- Не раздувай репозиторий без прямой пользы: лишняя сложность замедляет разработку и увеличивает риск ошибок агентов.

## Протокол реиндексации

Полная реиндексация summaries (drive/index/summaries.json) должна запрашивать OK владельца.
